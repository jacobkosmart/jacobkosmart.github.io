---
title: "3.Firestore Database"
excerpt: "firebase"

categories:
  - firebase

toc: true
toc_sticky: true
---

---

## 1.Cloud FireStore

- Cloud Firestore ì˜ database ëŠ” NoSQL database ì…ë‹ˆë‹¤. ê·¸ë˜ì„œ ê·œì¹™ë“¤ë„ ë§ì´ ì—†ê³  ìƒë‹¹íˆ ìœ ì—°í•˜ê³  ì‚¬ìš©í•˜ê¸°ë„ ì‰½ìŠµë‹ˆë‹¤.

- ê·œì¹™ì´ ë§ì´ ì—†ê¸° ë•Œë¬¸ì— ì¡°ê¸ˆ ì œí•œë˜ëŠ” ë¶€ë¶„ì´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### íŠ¹ì§•

- Collection : ê¸°ë³¸ì ì¸ í´ë”ì™€ ê°™ì´ category ë¥¼ ë‚˜ëˆŒìˆ˜ ìˆëŠ” ê¸°ëŠ¥

- Documentation : Collection ì•ˆì— ìˆëŠ” database ë¬¸ì„œë“¤ì„ ë§í•©ë‹ˆë‹¤.

- firebase database ë§Œë“¤ê¸°

í…ŒìŠ¤íŠ¸ ëª¨ë“œë¡œ ì¼ë‹¨ database ìƒì„±í•©ë‹ˆë‹¤

![image](https://user-images.githubusercontent.com/28912774/129293861-42819c4b-f52e-4b26-851d-1cfc16f58ed4.png)

- í”„ë¡œì íŠ¸ root ê²½ë¡œì— firebase.js íŒŒì¼ì—ì„œ firestore ë¥¼ import í•´ì¤˜ì•¼ í•©ë‹ˆë‹¤

```js
// in fbase.js on root your project
import "firebase/firestore";

// í”„ë¡œì íŠ¸ì—ì„œ dbService ë¼ëŠ” ì´ë¦„ìœ¼ë¡œ export í•´ì¤Œ
export const dbService = firebase.firestore();
```

> [firebase.firestore docs](https://firebase.google.com/docs/reference/js/firebase.firestore.Firestore)

## 2.Collection Reference

- collectionReference : collection ì•ˆì˜ document ë¥¼ ì¶”ê°€,ìˆ˜ì •, ì‚­ì œ í• ìˆ˜ ìˆëŠ” í•¨ìˆ˜

> [firebase.firestore.CollectionReference](https://firebase.google.com/docs/reference/js/firebase.firestore.CollectionReference)

### add (CREATE)

```js
import React, { useState } from "react";
import { dbService } from "../fbase";

const Home = () => {
  // State
  const [chat, setChat] = useState("");

  // Submit Function
  const onSubmit = async (e) => {
    e.preventDefault();
    // "chat"ì´ë¼ëŠ” collection ì— add ë¥¼ í•´ì„œ data ë¥¼ ë„£ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. chat ì€ useState ì—ì„œ ì €ì¥ëœ ê°’ (input ì—ì„œ ë„˜ì–´ì˜¤ëŠ” ê°’ì„ ë„£ì–´ ì¤„ìˆ˜ ìˆìŠµë‹ˆë‹¤)
    await dbService.collection("chat").add({
      chat,
      createAt: Date.now(),
    });
    // db ì— ë“±ë¡í•œ í›„, ë‹¤ì‹œ ì´ˆê¸°í™” í•¨
    setChat("");
  };
  const onChange = (e) => {
    const {
      target: { value },
    } = e;
    setChat(value);
  };

  return (
    <div>
      <>
        <form onSubmit={onSubmit}>
          <input
            value={chat}
            onChange={onChange}
            type="text"
            placeholder="what's on your mind?"
            maxLength={120}
          />
          <input type="submit" value="chat" />
        </form>
      </>
    </div>
  );
};
```

### get (READ)

- ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ê¸° ìœ„í•´ get() í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•¨

> [firebase.firestore.CollectionReference.get()](https://firebase.google.com/docs/reference/js/firebase.firestore.CollectionReference#get)

![image](https://user-images.githubusercontent.com/28912774/129304122-eb3b3b09-409d-45c8-a81c-ebbc87477e69.png)

- return ê°’ìœ¼ë¡œ promise QuerySnapshot ì„ ê°€ì ¸ì˜¤ëŠ”ë° ë°ì´í„°ë² ì´ìŠ¤ì— ìˆëŠ” query docs í˜•íƒœë¡œ ê°€ì ¸ì˜´

> [firebase.firestore.QuerySnapshot](https://firebase.google.com/docs/reference/js/firebase.firestore.QuerySnapshot)

> [firebase.firestore.QueryDocumentSnapshot](https://firebase.google.com/docs/reference/js/firebase.firestore.QueryDocumentSnapshot#data)

data() í•¨ìˆ˜ í˜•íƒœë¡œ dataë¥¼ ë¶ˆëŸ¬ ì˜¬ìˆ˜ ìˆìŒ

```js
const getChats = async () => {
  const dbChats = await dbService.collection("chats").get();
  dbChats.forEach((document) => console.log(document.data()));
};
```

- DB ì— ìˆëŠ” data ë¥¼ ê°€ì ¸ì™€ì„œ í™”ë©´ì— í‘œì‹œí•˜ëŠ” ë°©ë²•

```js
const [chats, setChats] = useState([]);

// read DB
const getChats = async () => {
  const dbChats = await dbService.collection("chats").get();
  dbChats.forEach((document) => {
    const chatsObj = {
      id: document.id,
      ...document.data(),
    };
    // ìµœê·¼ì˜ documentì™€ ì´ì „ì˜ documentë¥¼ ë¶™ì—¬ì„œ setChats ìœ¼ë¡œ ë‹¤ì‹œ í• ë‹¹
    setChats((prev) => [chatsObj, ...prev]);
  });
};
// mount í• ë•Œ dbService ì—ì„œ ì‹¤í–‰í•  useEffect
useEffect(() => {
  getChats();
}, []);

return (
  <div>
    {chats.map((chat) => (
      <div key={chat.id}>
        <h4>{chat.chat}</h4>
      </div>
    ))}
  </div>
);
```

- `onSnapshot()` ì„ í†µí•´ì„œ dataë¥¼ ê°€ì ¸ì˜¤ëŠ” ë°©ì‹(ìœ„ì˜ `const getChats` ë¥¼ ëŒ€ì‹  í•  ìˆ˜ ìˆìŒ!!)

```js
// read DB realtime

useEffect(() => {
  dbService
    .collection("chats")
    .orderBy("createAt", "desc")
    .onSnapshot((snapshot) => {
      const chatArray = snapshot.docs.map((doc) => ({
        id: doc.id,
        ...doc.data(),
      }));
      setChats(chatArray);
      console.log(chatArray);
    });
}, []);
```

- query ë¥¼ ì´ìš©í•˜ëŠ”ê²Œ ì•„ë‹ˆë¼ snapshot ìœ¼ë¡œ ì‚¬ìš©í–ˆê¸° ë•Œë¬¸ì— ì‹¤ì‹œê°„ìœ¼ë¡œ í™•ì¸í•  ìˆ˜ ìˆê²Œ ë¨

### delete (DELETE)

- ë¨¼ì € ì‘ì„±ìê°€ ì¸ê²½ìš°ì—ë§Œ delete edit í•  ìˆ˜ ìˆê²Œ ì„¤ì •í•˜ê¸°

```js
// in Home.js <Chat> ì— props data ë¡œ userObj.uid ë¥¼ chat.creatorID ì™€ ê°™ì€ ê²½ìš°ê°€ isOwner{true} ë¥¼ Chat.js ì— ë„˜ê¹€

<div>
  {chats.map((chat) => (
    <Chat
      key={chat.id}
      chatObj={chat}
      isOwner={chat.creatorID === userObj.uid}
    />
  ))}
</div>
```

```js
// in Chat.js

import React from "react";

const Chat = ({ chatObj, isOwner }) => {
  return (
    <>
      <div>
        <h4>{chatObj.text}</h4>
        // isOwner ê°€ true ì¼ë•Œë§Œ delete, edit ë²„íŠ¼ì´ ë³´ì´ê²Œ ìˆ˜ì •
        {isOwner && (
          <>
            <button>Delete Chat</button>
            <button>Edit Chat</button>
          </>
        )}
      </div>
    </>
  );
};

export default Chat;
```

> [firebase.firestore.DocumentReference Delete](firebase.firestore.DocumentReference)

- ì‚­ì œ : ë©”ì„¸ì§€ì˜ id ë¥¼ ì§€ì •í–ˆê¸° ë•Œë¬¸ì— id ë¥¼ ì°¾ì•„ì„œ delete í•´ì£¼ë©´ ë©ë‹ˆë‹¤

```js
  // Delete function
  const onDeleteClick = async () => {
    const check = window.confirm("ì •ë§ë¡œ ë©”ì„¸ì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
    if (check) {
      // delete ok
      await dbService.doc(`chats/${chatObj.id}`).delete();
    }
  }

  return (
    <>
      <div>
        <h4>{chatObj.text}</h4>
        {isOwner && (
          <>
            <button onClick={onDeleteClick}>Delete Chat</button>
            <button>Edit Chat</button>
          </>
        )}
      </div>
    </>
  );
};
```

<!-- TODO https://nomadcoders.co/nwitter/lectures/1923 3.35 ì´ˆ ë³¼ì°¨ë¡€ -->

ğŸ”¶ ğŸ”· ğŸ“Œ ğŸ”‘

## Reference

- normad corder hooks - [https://nomadcoders.co/react-hooks-introduction/lobby](https://nomadcoders.co/react-hooks-introduction/lobby){:target="\_blank"}

```

```
