---
title: "4.Storage"
excerpt: "firebase"

categories:
  - firebase

toc: true
toc_sticky: true
---

---

## 1.Preview Images

- Storage ì— ì €ì¥ í•˜ê¸°ì „ì— react project app ì—ì„œ img íŒŒì¼ì„ ì—…ë¡œë“œë¥¼ í•´ì„œ ì½ì€ ë‹¤ìŒì— preview í•´ë³´ê¸°

> [fileReader](https://developer.mozilla.org/en-US/docs/Web/API/FileReader)

- fileReader API ë¥¼ í†µí•´ì„œ ì—…ë¡œë“œëœ íŒŒì¼ì„ ì½ê³  preview ì‚¬ì§„ ì—…ë¡œë“œ ì—†ì• ê¸°

```js
// Create State
  const [attachment, setAttachment] = useState();

    // fileUpload function
  const onFileChange = (e) => {
    // es6 ì˜ êµ¬ì¡°ë¶„í•´ í• ë‹¹ target ì•ˆì— files ë¥¼ event listener ë¡œ ë°›ì€ ê°’ì„ files ì— ì €ì¥
    const {
      target: { files },
    } = e;
    // ë°°ì—´ì˜ ì²«ë²ˆì§¸ íŒŒì¼ë§Œ theFile ë¡œ ì„ ì–¸í•˜ê³  fileReader API ë¥¼ í†µí•´ ì´ë¯¸ì§€ íŒŒì¼ ì½ê¸°
    const theFile = files[0];
    const reader = new FileReader();
    reader.onloadend = (finishedEvent) => {
      const {
        currentTarget: { result },
      } = finishedEvent;
      setAttachment(result);
    };
    reader.readAsDataURL(theFile);
  };

  // Delete Photo
  const onClearAttachment = () => {
    setAttachment(null);
  };

  return (
  {attachment && (
    <div>
<img src={attachment} alt="img" width="50px" height="50px" />
    <button onClick={onClearAttachment}>Clear Photo</button>
  </div>
)}
  )
```

## 2.Upload to Firebase Storage

- firebase.js (ì•„ë˜ ì˜ˆì‹œì—ì„œëŠ” fbase.js) ì—ì„œ firebase storage service import

```js
// in fbase.js
import "firebase/storage";

export const storageService = firebase.storage();
```

> [firebase.storage.Reference](https://firebase.google.com/docs/reference/js/firebase.storage.Reference)

- reference ëŠ” google cloud storage object ì— ëŒ€í•œ ì°¸ì¡°ë¥¼ ë‚˜íƒ€ ë‚´ëŠ”ê²ƒ ì´ê²ƒì´ bucket ì¸ê²ƒì…ë‹ˆë‹¤.

> [reference child](https://firebase.google.com/docs/reference/js/firebase.storage.Reference#child)

- ì—¬ê¸°ì„œ childì— ë„£ì„ê²ƒì€ ê¸°ë³¸ì ìœ¼ë¡œ upload í•œ íŒŒì¼ì˜ path ì„ collection ê³¼ ë¹„ìŠ·í•œë° í´ë”ë¥¼ ë§Œë“¤ì–´ì„œ íŒŒì¼ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.

ğŸ“Œ ì°¸ê³ : path ë¥¼ ë§Œë“¤ë•Œ uuid ë¥¼ ì‚¬ìš©í•´ì„œ ê¸°ë³¸ì ìœ¼ë¡œ ì–´ë–¤ íŠ¹ë³„í•œ ì‹ë³„ìë¥¼ ëœë¤ìœ¼ë¡œ ìƒì„±í•´ì¤Œ yarn ë˜ëŠ” npm package ì„¤ì¹˜í•´ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (unique identify)

> [uuid package](https://yarnpkg.com/package/uuid)

```bash
yarn add uuid
```

```js
// create uuid
import { v4 as uuidv4 } from "uuid";
uuidv4();

// Create reference.child
const fileRef = storageService.ref().child(`${userObj.uid}/${uuidv4()}`);
```

- fileReference ë¥¼ ë§Œë“ ë‹¤ìŒì— putString ì„ í†µí•´ì„œ fileUpload í•œ string ì„ ë„£ì–´ ì¤ë‹ˆë‹¤.

> [putString](https://firebase.google.com/docs/reference/js/firebase.storage.Reference#putstring)

```js
const response = await fileRef.putString(attachment, "data_url");
```

- getDownloadURL ì„ ì‚¬ìš©í•´ì„œ reference ì˜ public url ì„ ì•Œì•„ë‚¸ë‹¤ìŒì— chatObj ì˜ object data ë¡œ ì¶”ê°€ ì‹œì¼œ ì¤ë‹ˆë‹¤.

```js
let attachmentUrl = await response.ref.getDownloadURL();
const chatObj = {
  text: chat,
  createAt: Date.now(),
  creatorID: userObj.uid,
  attachmentUrl,
};
```

> [getDownloadURL](https://firebase.google.com/docs/reference/js/firebase.storage.Reference#getdownloadurl)

## 3.Delete file

- Delete ë¼ê¸° ìœ„í•´ì„  attach ëœ íŒŒì¼ ì¦‰, firebase storage ì— ì €ì¥ëœ íŒŒì¼(ì‚¬ì§„) ë„ ê°™ì´ ì‚­ì œ í•´ì¤˜ì•¼ í•˜ëŠ”ë° `attachmentUrl` ì— ì‚¬ìš©ëœ public url ì„ firebase method ì˜ refFromURL ì— ë„˜ê¸´ë‹¤ë©´ ê·¸ object ì— ëŒ€í•œ reference ë¥¼ ì–»ì„ ìˆ˜ ìˆê²Œ ë˜ì„œ delete í•˜ê¸° ì‰¬ì›Œ ì§„ë‹¤.

> [refFromURL](https://firebase.google.com/docs/reference/js/firebase.storage.Storage#reffromurl)

```js
const onDeleteClick = async () => {
  const check = window.confirm("ì •ë§ë¡œ ë©”ì„¸ì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
  if (check) {
    // delete chat
    await dbService.doc(`chats/${chatObj.id}`).delete();
    // delete uploadFile
    await storageService.refFromURL(chatObj.attachmentUrl).delete();
  }
};
```

ğŸ”¶ ğŸ”· ğŸ“Œ ğŸ”‘

## Reference

- normad corder firebase - [https://nomadcoders.co/nwitter/lobby](https://nomadcoders.co/nwitter/lobby){:target="\_blank"}
