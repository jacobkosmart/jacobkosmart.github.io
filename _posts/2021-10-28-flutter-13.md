---
title: "Bloc Pattern (with flutter_bloc Plugin)"
excerpt: "flutter"

categories:
  - flutter

toc: true
toc_sticky: true
---

# 1.ì™œ? Bloc Pattern ì¨ì•¼ í•˜ëŠ”ê°€?

- ëª¨ë“  flutter app ì€ Stateful Widget ì„ ì‚¬ìš©í•´ì„œ ë™ì ì¸ í™”ë©´ì„ ë³€ê²½ì„ `setState()` ë¥¼ ì‚¬ìš©í•´ì„œ ì‰½ê²Œ êµ¬í˜„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

- í•˜ì§€ë§Œ, ì´ëŸ°í•œ êµ¬ì¡°ëŠ” ë‹¨ìˆœí•œ ìœ„ì ¯ì˜ êµ¬ì¡° ì¼ ê²½ìš°ì— í•´ë‹¹ë˜ëŠ” ë¶€ë¶„ì´ê³ , ë³´í†µ App ì„ ë§Œë“¤ê³  ì‚¬ìš©ìë“¤ì—ê²Œ ë°°í¬ë¥¼ í•  ê²½ìš° ì„œë²„ë¡œ ë¶€í„° data ë¥¼ ë°›ì•„ì˜¤ê±°ë‚˜, local ì— ìˆëŠ” data ë¥¼ business logic ë¥¼ í†µí•´ ë§Œë“¤ê²½ìš° ë³µì¡í•œ Widget tree ê°€ ë˜ê²Œ ë©ë‹ˆë‹¤. ì´ëŸ¬í•œ ê²½ìš°ì— `setState()` ë¡œë§Œ ì‚¬ìš©í•´ì„œ data ë¥¼ ë³€ê²½ í•  ê²½ìš° ë” ë³µì¡í•˜ê²Œ ë©ë‹ˆë‹¤

- ì´ëŸ¬í•œ ë¶ˆí¸í•˜ê³ , ë³µì¡í•œ ë¶€ë¶„ì„ í•´ê²°í•˜ê¸° ìœ„í•´ Bloc (Business Logic Component) pattern ì´ë¼ê³  í•©ë‹ˆë‹¤. ë§ ê·¸ëŒ€ë¡œ Business logic ì„ ë”°ë¡œ ë•Œë‚´ì–´ ë¶„ë¦¬í•œ ì¼ì¢…ì˜ component ì…ë‹ˆë‹¤.

- UI ë¶€ë¶„ì—ì„œëŠ” business ë¶€ë¶„ì„ ê´€ì—¬í•  í•„ìš”ê°€ ì—†ê²Œ ë˜ë©°, data ì˜ ê°’ì„ ê°€ê³µí•  í•„ìš”ê°€ ì—†ê²Œ ë˜ê³  bloc pattern ë¡œ ì •ë¦¬ëœ data ë¥¼ ê·¸ëŒ€ë¡œ ë°›ì•„ì„œ ë³´ì—¬ì£¼ê¸°ë§Œ í•˜ë©´ ë˜ê³ , ëª¨ë“  business logic ì€ bloc pattern ì—ì„œ ë‹¤ë£¨ê²Œ ë©ë‹ˆë‹¤.

![image](https://user-images.githubusercontent.com/28912774/139241486-f5f912ea-be8d-4c0c-bade-54126b320670.png)

- ìœ„ì˜ ê·¸ë¦¼ì—ì„œëŠ” UI widget ì—ì„œëŠ” events ë§Œ bloc ì— ë„˜ê¸°ê³  bloc ì•ˆì— transition ì´ë¼ë˜ì§€ ëª¨ë“  state ëŠ” bloc ì•ˆì—ì„œ Streams ë¡œ UI widget ì— ë„˜ê¸°ê²Œ ë©ë‹ˆë‹¤

- bloc pattern ì˜ ê°€ì¥ í° ì¥ì ì€ state ë¥¼ widget tree ìƒì—ì„œ ê´€ë¦¬í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ì˜ˆì „ì—ëŠ” ë§Œì•½ `scaffold ` ìƒì˜ `setState()` ë¥¼ ë³€ê²½í• ë•ŒëŠ” ì „ì²´ widget tree ì—ì„œ build context ì—ì„œ reload ê°€ ë˜ì§€ ì•Šê¸° ë•Œë¬¸ì— tree êµ¬ì¡°ê°€ ë³µì¡í•  ê²½ìš°, app êµ¬ë™ ì†ë„ê°€ ë¹¨ë¼ ì§‘ë‹ˆë‹¤

![image](https://user-images.githubusercontent.com/28912774/139245328-f15f5363-4f06-492a-8da2-a83dd679e75f.png)

![image](https://user-images.githubusercontent.com/28912774/139245228-9535dabd-7a48-4b70-99c1-9c70f3560f27.png)

## Bloc pattern ì˜ ë‹¨ì 

- ê´€ë¦¬ë˜ëŠ” íŒŒì¼ì´ ë§ì´ ì§‘ë‹ˆë‹¤. (state ë¥¼ ë‹¤ë£¨ëŠ”ê²Œ í•˜ë‚˜ì˜ Bloc ë§Œ ìˆëŠ”ê²ƒì´ ì•„ë‹ˆë¼, ë‹¤ìˆ˜ì˜ Bloc ì´ ìˆì„ ê²ƒì¸ë°, ê´€ë¦¬í•˜ê¸°ê°€ ë³µì¡í•˜ê³ , `setState()` ì™€ ë¹„êµí•´ë„ ë³µì¡í•œ êµ¬ì¡°ë¥¼ ê°€ì§€ê³  ìˆê²Œ ë©ë‹ˆë‹¤)

- ê·¸ê²ƒì„ ë³´ì•ˆí•˜ê¸° ìœ„í•´ì„œ ë‚˜ì˜¨ê²ƒì´ `Provider` ê°€ ìˆìŠµë‹ˆë‹¤

## Bloc pattern code ì˜ˆì‹œë¡œ

- flutter ì„¤ì¹˜ì‹œ demo ë¡œ ë³´ì´ëŠ” ìˆ«ì count ë˜ëŠ” í™”ë©´ì„ bloc pattern ìœ¼ë¡œ ë§Œë“  ì˜ˆì‹œ ì…ë‹ˆë‹¤

![image](https://user-images.githubusercontent.com/28912774/139354445-ef1f6ce6-92dc-4aeb-afff-028dd5c8eece.png)

êµ¬ì¡°ëŠ” ui ë¶€ë¶„ ui ë¶€ë¶„ì˜ body ë¶€ë¶„ì€ component ë¡œ ë¶„ë¦¬í•´ì„œ `count_view.dart` íŒŒì¼ë¡œ ì´ë£¨ì–´ ì ¸ìˆê³  ëª¨ë“  state ê°’ì€ bloc í´ë”ì— `count_bloc.dart` ì— ìœ„ì¹˜í•˜ê²Œ ë©ë‹ˆë‹¤

```dart
// in main.dart

class _HomeState extends State<Home> {
  @override
  Widget build(BuildContext context) {
    return SafeArea(
      child: Scaffold(
        body: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          crossAxisAlignment: CrossAxisAlignment.stretch,
          children: [
            Center(
              child: ElevatedButton(
                child: Text("bloc íŒ¨í„´"),
                onPressed: () {
                  Navigator.push(context, MaterialPageRoute(builder: (_) {
                    return BlocDisplayWidget();
                  }));
                },
              ),
            ),
          ],
        ),
      ),
    );
  }
}

```

```dart
// in bloc_display_widget.dart

// Global ë³€ìˆ˜ìƒì„±
CountBloc countBloc;

class BlocDisplayWidget extends StatefulWidget {
  BlocDisplayWidget({Key key}) : super(key: key);

  @override
  _BlocDisplayWidgetState createState() => _BlocDisplayWidgetState();
}

class _BlocDisplayWidgetState extends State<BlocDisplayWidget> {
  // initState() : Bloc ìƒì„±
  @override
  void initState() {
    super.initState();
    countBloc = CountBloc();
  }

  // dispose() : í˜ì´ì§€ê°€ ë‹«íˆë©´ app ì´ dispose ë˜ê²Œ í•¨
  @override
  void dispose() {
    super.dispose();
    countBloc.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text("bloc íŒ¨í„´"),
      ),
      body: CountView(countBloc: countBloc),
      floatingActionButton: FloatingActionButton(
        child: Icon(Icons.add),
        onPressed: () {
          countBloc.add();
        },
      ),
    );
  }
}

```

```dart
// in count_view.dart

class CountView extends StatelessWidget {
  CountBloc countBloc;
  CountView({Key key, this.countBloc}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    print("CountView Build!!");
    return Center(
      child: StreamBuilder(
        stream: countBloc.count,
        initialData: 0,
        // AsyncSnapshot ìœ¼ë¡œ ê°’ì´ ë“¤ì–´ì˜¤ê²Œ ë¨
        builder: (BuildContext context, AsyncSnapshot<int> snapshot) {
          if (snapshot.hasData) {
            return Text(
              snapshot.data.toString(),
              style: TextStyle(fontSize: 70.0),
            );
          }
          return CircularProgressIndicator();
        },
      ),
    );
  }
}

```

```dart
// in count_bloc.dart

class CountBloc {
  int _count = 0;
  final StreamController<int> _countSubject = StreamController<int>();
  // ë³€ê²½ëœ widget ê°’ì„ ì „ë‹¬ í•˜ê²Œ ë¨
  Stream<int> get count => _countSubject.stream;

  add() {
    _count++;
    _countSubject.sink.add(_count);
  }

  dispose() {
    _countSubject.close();
  }
}

```

# 2.flutter_bloc package

> [flutter_bloc_package](https://pub.dev/packages/flutter_bloc)

- bloc pattern ì„ flutter ì— ì ìš©í• ê²½ìš°, package ì—†ì´ ê·¸ëƒ¥ custom í•˜ê²Œ ë  ê²½ìš° ì‘ì„±í•´ì•¼ë  ê²½ìš°ê°€ ë„ˆë¬´ ë§ê²Œ ë˜ê³  ê´€ë¦¬ë„ ë³µì¡í•˜ê¸° ë•Œë¬¸ì— flutter ì—ì„œ bloc íŒ¨í„´ ì‚¬ìš©ì‹œ ì£¼ë¡œ flutter_bloc_package ë¥¼ ì„¤ì¹˜í•´ì„œ ì‚¬ìš©í•˜ê²Œ ë©ë‹ˆë‹¤

## flutter_bloc package ì‚¬ìš© ì˜ˆì œ(todo List) í™˜ê²½ ì„¤ì •

### ì„¤ì¹˜ dependency

```yaml
dependencies:
  flutter:
    sdk: flutter
  cupertino_icons: ^1.0.0
  flutter_bloc: ^7.3.1
  freezed_annotation:
  json_annotation: ^4.3.0
  equatable:

dev_dependencies:
  flutter_test:
    sdk: flutter
  build_runner:
  freezed:
  json_serializable:
```

### model ìƒì„±

- freezed ë¥¼ ì‚¬ìš©í•´ì„œ Todo class model ìƒì„±

> ì°¸ì¡° [Flutter Freezed](https://jacobko.info/flutter/flutter-14/)

```dart
 // in model/todo.dart

import 'package:freezed_annotation/freezed_annotation.dart';

part 'todo.freezed.dart';
part 'todo.g.dart';

@freezed
class Todo with _$Todo {
  factory Todo({
    required int id,
    required String title,
    required String createdAt,
  }) = _Todo;

  factory Todo.fromJson(Map<String, dynamic> json) => _$TodoFromJson(json);
}

```

### repository ìƒì„±

```dart
// in repository/todo_repository.dart

// todo list app ì€ ì‹¤ì œë¡œ ë§Œë“¤ë©´ server ì™€ ì—°ë™ì„ í•˜ê²Œ ë˜ëŠ”ë° RestAPI ì—°ë™í•˜ëŠ”ê²ƒì„ ì‹œë®¬ë ˆì´ì…˜ í•˜ê¸° ìœ„í•œ repository ìƒì„±

// 3ê°œì˜ method ìƒì„± (ì´ë²¤íŠ¸ ì²˜ë¦¬ë¥¼ ìœ„í•œ)
// GET = listTodo
// POST = createTodo
// DELETE = deleteTodo

import 'package:flutter_bloc_sample/model/todo.dart';

class TodoRepository {
  Future<List<Map<String, dynamic>>> listTodo() async {
    await Future.delayed(Duration(seconds: 1));
    return [
      {
        'id': 1,
        'title': 'Flutter Study',
        'createdAt': DateTime.now().toString(),
      },
      {
        'id': 2,
        'title': 'Dart Study',
        'createdAt': DateTime.now().toString(),
      },
    ];
  }

  Future<Map<String, dynamic>> createTodo(Todo todo) async {
    // ì›ë˜ëŠ” ì´ëŸ° ë°©ì‹ìœ¼ë¡œ ì‘ì„±í•´ì•¼ í•˜ëŠ”ë° body - request - response - return ê³¼ì •ì„ ìƒëµí•œê²ƒì„
    await Future.delayed(Duration(seconds: 1));

    return todo.toJson();
  }

  Future<Map<String, dynamic>> deleteTodo(Todo todo) async {
    await Future.delayed(Duration(seconds: 1));

    return todo.toJson();
  }
}

```

## bloc state

- bloc state ì€ ê°€ì¥ í•µì‹¬ ì ì¸ ë¶€ë¶„ì…ë‹ˆë‹¤. ì–´ë– í•œ ìƒíƒœë¥¼ ê°€ì§€ê³  ìˆëŠ”ê°€ë¥¼ ê²°ì •í•˜ê²Œ ë©ë‹ˆë‹¤. ë‚˜ì¤‘ì— bloc ì„ ìƒì„±í• ë•Œ, ì–´ë– í•œ type ì´ ìƒíƒœê°€ ë ì§€ë¥¼ ì…ë ¥ì„ í•´ì¤˜ì•¼ ë˜ê¸° ë•Œë¬¸ì— í•˜ë‚˜ì˜ base class ë¥¼ ë§Œë“¤ì–´ì„œ ë‹¤ extend í•œ ë‹¤ìŒì— ìƒíƒœë“¤ì„ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤

- Equatable í”ŒëŸ¬ê·¸ì¸ì„ ì‚¬ìš©í•´ì„œ TodoState ì— ì ìš©í•´ì¤ë‹ˆë‹¤

> [ì™œ Equatable í”ŒëŸ¬ê·¸ì¸ì€ ì‚¬ìš©í•˜ëŠ”ì§€ì— ëŒ€í•œ ê¸€](https://jacobko.info/flutter/flutter-16/)

```dart

// in bloc/todo_state.dart

import 'package:equatable/equatable.dart';
import 'package:flutter/material.dart';
import 'package:flutter_bloc_sample/model/todo.dart';

// immutable TodoState extends Equatable
@immutable
abstract class TodoState extends Equatable {}

// Empty TodoState : ë§¨ì²˜ìŒì— ì•„ë¬´ê²ƒë„ state ê°€ ì—†ì„ë•Œ ì‚¬ìš©
class Empty extends TodoState {
  @override
  // TODO: implement props
  List<Object?> get props => [];
}

// Loading TodoState :RestAPI ì— ìš”ì²­ì„ í–ˆì„ ë•Œ ì‚¬ìš©(repository ì‹¤í–‰ í–ˆì„ë•Œ)
class Loading extends TodoState {
  @override
  // TODO: implement props
  List<Object?> get props => [];
}

// Error TodoState : server ì—ì„œ error message ê°€ ë‚˜ì™”ì„ë•Œ
class Error extends TodoState {
  final String message;

  Error({
    required this.message,
  });

  @override
// TODO: implement props
  List<Object?> get props => [this.message];
}

// Loaded TodoState : Loaded ê°€ ì™„ë£Œ ë˜ëŠ” ì‹œì ì— todos list ì— ê°’ì„ ë„˜ê²¨ ì£¼ëŠ” state
class Loaded extends TodoState {

  final List<Todo> todos;

  Loaded({
    required this.todos
  })

  @override
// TODO: implement props
  List<Object?> get props => [this.todos];
}
```

## bloc event

- bloc_flutter ë¥¼ ì“¸ë•Œ 2ê°€ì§€ ê°œë…ì´ ìˆëŠ”ë° cubic ì„ ì‚¬ìš©í• ë•ŒëŠ” event ê°€ í•„ìš” ì—†ì§€ë§Œ, bloc ì„ ì‚¬ìš©í• ë•ŒëŠ” event ê°€ í•„ìš”í•´ì„œ ë§Œë“  íŒŒì¼ ì„

- event ëŠ” ê±°ì˜ restAPI ì˜ endpoint ì™€ ê°¯ìˆ˜ê°€ ê°™ì•„ì•¼ í•œë‹¤ (Get, Create, Delete í•´ì˜¤ëŠ”ê±°ì™€ ê°™ì´. )

```dart
// in bloc/todo_state.dart

import 'package:equatable/equatable.dart';
import 'package:flutter/material.dart';
import 'package:flutter_bloc_sample/model/todo.dart';

// ê¸°ë³¸ class ìƒì„±

@immutable
abstract class TodoEvent extends Equatable {}

class ListTodosEvent extends TodoEvent {
  @override
  // TODO: implement props
  List<Object?> get props => [];
}

// todo ë¥¼ ì…ë ¥ ë°›ê²Œ ë˜ì–´ ìˆëŠ”ë°, ê·¸ë ‡ê²Œ í•˜ë ¤ë©´ todo ì•ˆì—ì„œë„ todo object ë¥¼ ê°€ì§€ê³  ìˆì–´ì•¼ í•¨
class CreateTodoEvent extends TodoEvent {
  final Todo todo;

  CreateTodoEvent({
    required this.todo,
  });

  @override
  // TODO: implement props
  List<Object?> get props => [this.todo];
}

// DeleteTodo ì—ì„œë„ Todo object ê°€ ë“¤ì–´ê°€ ì‡ìœ¼ë‹ˆê¹Œ ê°™ì´ ë°›ì•„ ì¤˜ì•¼ í•¨
class DeleteTodoEvent extends TodoEvent {
  final Todo todo;

  DeleteTodoEvent({
    required this.todo,
  });

  @override
  // TODO: implement props
  List<Object?> get props => [this.todo];
}
```

## bloc logic ìƒì„±

- flutter_bloc library ì—ì„œ ì œê³µì„ í•´ì£¼ëŠ” bloc base class ë¡œëŠ” 2ê°€ì§€ê°€ ìˆìŠµë‹ˆë‹¤. cubic ê³¼ bloc ì´ ìˆëŠ”ë° ë¨¼ì € bloc ì— ëŒ€í•´ì„œ ë¡œì§ì„ êµ¬ì„±í•´ ë´…ë‹ˆë‹¤

```dart
// in bloc/todo_bloc.dart

import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:flutter_bloc_sample/bloc/todo_event.dart';
import 'package:flutter_bloc_sample/bloc/todo_state.dart';
import 'package:flutter_bloc_sample/model/todo.dart';
import 'package:flutter_bloc_sample/repository/todo_repository.dart';

// Bloc logic ìƒì„±
// <> generic ìœ¼ë¡œ ì²«ë²ˆì§¸ëŠ” event ë¥¼ ë°›ê³ , ê·¸ ë‹¤ìŒì—ëŠ” stateë¥¼ ë°›ìŠµë‹ˆë‹¤

class TodoBloc extends Bloc<TodoEvent, TodoState> {
  // dependancy injection í•˜ê¸° ìœ„í•œ ë³€ìˆ˜ ì„ ì–¸
  final TodoRepository repository;

  // constructor ìƒì„± : super ì—ëŠ” ê°€ì¥ ê¸°ë³¸ì´ ë˜ëŠ” state ì¸ Empty() ë¥¼ ë„£ì–´ ì¤Œ(ì²˜ìŒ ì‹¤í–‰í• ë•Œ ì•„ë¬´ê²ƒë„ ì—†ëŠ” ìƒíƒœì´ê¸° ë•Œë¬¸ì„) / TodoBloc ì•ˆì—ì„œ repository ì˜ ë¡œì§ë„ ì•ˆì—ì„œ ì‹¤í–‰í•˜ê¸° ìœ„í•´ì„œ dependency injection ì„ í•´ì¤Œ
  TodoBloc({
    required this.repository,
  }) : super(Empty());

  // ëª¨ë“  event ë“¤ì´ ì´ í•¨ìˆ˜ë¥¼ í†µí•´ì„œ ì‹¤í–‰ì´ ë¨
  // Stream ì€ async* í•´ì¤˜ì•¼í•¨ Future ëŠ” ê·¸ëƒ¥ async
  @override
  Stream<TodoState> mapEventToState(TodoEvent event) async* {
    // ë¨¼ì € ì–´ë– í•œ event ì¸ì§€ check í•˜ëŠ” ê²ƒ (ListTodosEvent, CreateTodoEvent, DeleteTodoEvent)
    if (event is ListTodosEvent) {
      yield* _mapListTodoEvent(event);
    } else if (event is CreateTodoEvent) {
      yield* _mapCreateTodoEvent(event);
    } else if (event is DeleteTodoEvent) {
      yield* _mapDeleteTodoEvent(event);
    }
  }

  // ì•„ë˜ì˜ ë¡œì§ì´ ê°€ì¥ ì²˜ìŒìœ¼ë¡œ UI ì™€ ì—°ê²°ë˜ëŠ” ë¶€ë¶„ì´ê¸° ë•Œë¬¸ì— Stream builder í˜•íƒœë¡œ Stream ìœ¼ë¡œ ë“¤ì–´ê°€ê²Œ ë˜ëŠ”ë° UI ì—ì„œ error ê°€ ë‚˜ëŠ”ê²ƒì„ ìµœì†Œí™” ì‹œì¼œ ì¤˜ì•¼ í•¨. ê·¸ë˜ì„œ ëª¨ë“  error ë¥¼ ì´ ë‹¨ê³„ì—ì„œ ì„¤ì •ì„ í•¨(try , catch ë¡œ)
  // _mapListTodoEvent Stream logic ìƒì„±
  Stream<TodoState> _mapListTodoEvent(ListTodosEvent event) async* {
    try {
      // circular indicator ë¥¼ ë³´ì—¬ì£¼ê¸° ìœ„í•´ Loadingì„ í˜¸ì¶œ
      yield Loading();

      // repository ì—ì„œ ê°€ì ¸ì˜¨ ì •ë³´ ë³€ìˆ˜ ì„ ì–¸
      final resp = await this.repository.listTodo();

      // listTodo ëŠ” Map<String, dynamic> ì„ return í•´ì£¼ê¸° ë•Œë¬¸ì— ë”°ë¡œ class í™”ë¥¼ í•´ì¤˜ì•¼ í•¨
      final todos = resp.map<Todo>((e) => Todo.fromJson(e)).toList();

      // ê°’ì„ ê°€ì ¸ì™”ìœ¼ë‹ˆ loading ì´ ëë‚œê²ƒì„ í˜¸ì¶œí•˜ê³  todos ë¥¼ ë„˜ê¸´ë‹¤
      yield Loaded(todos: todos);
    } catch (e) {
      yield Error(message: e.toString());
    }
  }

  // _mapCreateTodoEvent Stream logic ìƒì„±
  Stream<TodoState> _mapCreateTodoEvent(CreateTodoEvent event) async* {
    try {
      // ì•„ë˜ì˜ state ê°€ loaded state ì¸ì§€ í™•ì¸ (ì•„ì§ load ê°€ ì•ˆë¬ëŠ”ë° data ë¥¼ ê°€ì ¸ ì˜¤ë©´ ì•ˆë˜ê¸°ë•Œë¬¸ì—)
      if (state is Loaded) {
        // todo ë¥¼ ë§Œë“¤ê¸° ì „ì— ê¸°ì¡´ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ì•¼ í•¨
        // ëª¨ë‘ yield ëœê²ƒë“¤ì€ state ì•ˆì—ì„œ ê°€ì ¸ì˜¬ìˆ˜ ìˆìŒ state ì¸ë° ì‚¬ì‹¤ ì´ê±´ Loaded state ë¼ëŠ”ê²ƒ
        final parseState = (state as Loaded);

        // todo ìƒì„±
        final newTodo = Todo(
          //  ID: todos ì˜ ê¸¸ì´ -1 ì˜ index ì˜ id ê°’ì´ + 1 í•´ì„œ ì¶”ê°€ ID ë²ˆí˜¸ ìƒì„±
          id: parseState.todos[parseState.todos.length - 1].id + 1,
          // Title : event ì—ì„œ title ì„ ë¶ˆëŸ¬ì˜´
          title: event.title,
          // CreatedAt : ì§€ê¸ˆ ì‹œê°„ í˜¸ì¶œí•´ì„œ String ìœ¼ë¡œ ë°˜í™˜
          createdAt: DateTime.now().toString(),
        );

        // repository ì „ì†¡ì „ì— UI í™”ë©´ì— ë³€ê²½ëœ ë‚´ìš©ì„ í‘œì‹œí•´ì£¼ëŠ”ë¶€ë¶„ todos í˜¸ì¶œ
        // prevTodos ì— ê¸°ì¡´ì— ìˆëŠ”ê²ƒì„ ë³µì‚¬
        final prevTodos = [
          ...parseState.todos,
        ];

        // newTodos ì— ê¸°ì¡´ê±° + ìƒì„±í•œê±° ìƒˆë¡œ ìƒì„±
        final newTodos = [
          ...prevTodos,
          newTodo,
        ];

        // ìš”ì²­ì„ í•˜ê¸°ì „ì— ê°€ìƒìœ¼ë¡œ yield í•˜ê¸° (load ê°€ ë‹¤ ë¬ë‹¤ê³  ì„ì˜ë¡œ ì„ ì–¸ UI ì— í‘œì‹œí•˜ê¸° ìœ„í•´ì„œ)
        yield Loaded(todos: newTodos);

        // repository ë¡œ ë°ì´í„° ì „ì†¡
        final resp = await this.repository.createTodo(newTodo);

        // id ê°’ê³¼ createdAt ì˜ ê°’ì„ ì„œë²„ì— ìˆëŠ” ìª½ê³¼ UI ìª½ì˜ id ì™€ createdAt ì˜ ê°’ì„ ë§ì¶°ì•¼ ë˜ê¸°ë•Œë¬¸ì— repository ì „ì†¡í›„ì— ë‹¤ì‹œ Loaded í˜¸ì¶œí•´ì„œ ì—…ë°ì´íŠ¸ í•˜ëŠ”ê²ƒ
        yield Loaded(todos: [
          ...prevTodos,
          Todo.fromJson(resp),
        ]);
      }
    } catch (e) {
      yield Error(message: e.toString());
    }
  }

  // _mapDeleteTodoEvent Stream logic ìƒì„±
  Stream<TodoState> _mapDeleteTodoEvent(DeleteTodoEvent event) async* {
    try {
      if (state is Loaded) {
        final newTodos = (state as Loaded)
            .todos
            .where((todo) => todo.id != event.todo.id)
            .toList();

        yield Loaded(todos: newTodos);

        await repository.deleteTodo(event.todo);
      }
    } catch (e) {
      yield Error(message: e.toString());
    }
  }
}

```

## bloc logic ì„ UI ì— ë‚˜íƒ€ë‚´ê¸°

```dart
import 'package:flutter/material.dart';
import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:flutter_bloc_sample/bloc/todo_bloc.dart';
import 'package:flutter_bloc_sample/bloc/todo_event.dart';
import 'package:flutter_bloc_sample/bloc/todo_state.dart';
import 'package:flutter_bloc_sample/repository/todo_repository.dart';

class HomeScreen extends StatefulWidget {
  const HomeScreen({Key? key}) : super(key: key);

  @override
  _HomeScreenState createState() => _HomeScreenState();
}

class _HomeScreenState extends State<HomeScreen> {
  @override
  Widget build(BuildContext context) {
    // BlocProvider í˜¸ì¶œ ì‚¬ìš© :  Provider ë¥¼ ì´ˆê¸°í™” í•˜ëŠ” ì‘ì—…
    return BlocProvider(
      // í•¨ìˆ˜ë¥¼ ë§Œë“¤ì–´ì„œ bloc ì„ return í•´ì¤Œ : BlocProvider ê°€ ìƒì„±í•´ì¤€ bloc ì„ child ì— ìˆëŠ” HomeWidget() ì— TodoBloc ì´ ì‚¬ìš©ê°€ëŠ¥í•˜ë„ë¡ í•´ì¤Œ
      create: (_) => TodoBloc(repository: TodoRepository()),
      child: HomeWidget(),
    );
  }
}

class HomeWidget extends StatefulWidget {
  const HomeWidget({Key? key}) : super(key: key);

  @override
  _HomeWidgetState createState() => _HomeWidgetState();
}

class _HomeWidgetState extends State<HomeWidget> {
  String title = '';

  // initState ìƒì„±
  @override
  void initState() {
    // TODO: implement initState
    super.initState();

    // ListTodosEvent ë¥¼ BlocProvider ì—ì„œ TodoBloc ì„ ë¶€ë¥¼ ìˆ˜ ìˆëŠ”ê²ƒ
    BlocProvider.of<TodoBloc>(context).add(ListTodosEvent());
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text('Flutter Bloc'),
      ),
      floatingActionButton: FloatingActionButton(
        onPressed: () {
          // bloc ì„ ë¶€ë¥´ëŠ” 2ë²ˆì§¸ ë°©ë²• BlocProvider.of.. ìœ„ì˜ ê²ƒê³¼ ë™ì¼í•œê²ƒ
          context.read<TodoBloc>().add(
                CreateTodoEvent(
                  title: this.title,
                ),
              );
        },
        child: Icon(Icons.edit),
      ),
      body: Padding(
        padding: const EdgeInsets.symmetric(horizontal: 20.0),
        child: Column(
          children: [
            TextField(
              onChanged: (val) {
                this.title = val;
              },
            ),
            SizedBox(height: 16.0),

            // ë§Œë“¤ì–´ì§„ bloc ì„ ë¶ˆëŸ¬ë“¤ì´ê¸° ìœ„í•´ì„  BlocBuilder ë¥¼ ì‚¬ìš©í•´ì•¼ í•¨
            // 2ê°œì˜ generic ì„ ë¶ˆëŸ¬ì™€ì•¼ ë˜ëŠ”ë° ì²˜ìŒì—ëŠ” ì‹¤ì œ ê°€ì ¸ì˜¬ bloc ì„ ë‹¤ìŒì—ëŠ” ê·¸ê²ƒì˜ ìƒíƒœë¥¼ ë„£ì–´ì£¼ë©´ ë¨
            Expanded(
              child: BlocBuilder<TodoBloc, TodoState>(builder: (_, state) {
                // state ê°€ Empty ì´ë©´ ê·¸ëƒ¥ Container() return
                if (state is Empty) {
                  return Container();
                  // state ê°€ Error  ì¼ ê²½ìš°
                } else if (state is Error) {
                  return Container(
                    child: Text(state.message),
                  );
                  // state ê°€ Loading ì¤‘ì¼ë•ŒëŠ” circularProgressindecator()
                } else if (state is Loading) {
                  return Center(
                    child: CircularProgressIndicator(),
                  );
                  // state ê°€ Loaded ì¤‘ì¼ë•Œ ê¸°ì¡´ì˜ todos ë¥¼ ë¶ˆëŸ¬ ì˜¨ë‹¤ìŒì— item ë³„ë¡œ í™”ë©´ì— ë‚˜íƒ€ ë‚´ê¸°
                } else if (state is Loaded) {
                  final items = state.todos;

                  return ListView.separated(
                    itemBuilder: (_, index) {
                      final item = items[index];
                      return Row(
                        children: [
                          Expanded(
                            child: Text(
                              item.title,
                            ),
                          ),
                          GestureDetector(
                            onTap: () {
                              BlocProvider.of<TodoBloc>(context).add(
                                DeleteTodoEvent(todo: item),
                              );
                            },
                            child: Icon(Icons.delete),
                          )
                        ],
                      );
                    },
                    separatorBuilder: (_, index) => Divider(),
                    itemCount: items.length,
                  );
                }
                return Container();
              }),
            ),
          ],
        ),
      ),
    );
  }
}
```

## cubit ìœ¼ë¡œ logic ë§Œë“¤ê¸°

- flutter_bloc ì˜ 2ë²ˆì§¸ ë°©ë²•ìœ¼ë¡œ cubit ì„ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ì¸ë°, Provider ë‚˜ GetX ì™€ ë¹„ìŠ·í•œ ë°©ë²•ì…ë‹ˆë‹¤.

- ìœ„ì˜ todo_bloc.dart ì—ì„œ `_mapListTodoEvent`, `_mapCreateTodoEvent` , `_mapDeleteTodoEvent` ê³¼ ë§ˆì°¬ê°€ì§€ë¡œ ë˜‘ê°™ì€ logic ì¸ë° ë‹¤ë¥¸ì ì€.

  - cubit ì€ generic ìœ¼ë¡œ í•˜ë‚˜ë§Œ state ë¡œ ê°€ì§

  - yield ë¥¼ emit() ìœ¼ë¡œ ë°”ê¿” ì£¼ë©´ ë¨

```dart
// in bloc/todo_bloc.dart

import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:flutter_bloc_sample/bloc/todo_event.dart';
import 'package:flutter_bloc_sample/bloc/todo_state.dart';
import 'package:flutter_bloc_sample/model/todo.dart';
import 'package:flutter_bloc_sample/repository/todo_repository.dart';

// Bloc logic ìƒì„±
// <> generic ìœ¼ë¡œ ì²«ë²ˆì§¸ëŠ” event ë¥¼ ë°›ê³ , ê·¸ ë‹¤ìŒì—ëŠ” stateë¥¼ ë°›ìŠµë‹ˆë‹¤

class TodoBloc extends Bloc<TodoEvent, TodoState> {
  // dependency injection í•˜ê¸° ìœ„í•œ ë³€ìˆ˜ ì„ ì–¸
  final TodoRepository repository;

  // constructor ìƒì„± : super ì—ëŠ” ê°€ì¥ ê¸°ë³¸ì´ ë˜ëŠ” state ì¸ Empty() ë¥¼ ë„£ì–´ ì¤Œ(ì²˜ìŒ ì‹¤í–‰í• ë•Œ ì•„ë¬´ê²ƒë„ ì—†ëŠ” ìƒíƒœì´ê¸° ë•Œë¬¸ì„) / TodoBloc ì•ˆì—ì„œ repository ì˜ ë¡œì§ë„ ì•ˆì—ì„œ ì‹¤í–‰í•˜ê¸° ìœ„í•´ì„œ dependency injection ì„ í•´ì¤Œ
  TodoBloc({
    required this.repository,
  }) : super(Empty());

  // ëª¨ë“  event ë“¤ì´ ì´ í•¨ìˆ˜ë¥¼ í†µí•´ì„œ ì‹¤í–‰ì´ ë¨
  // Stream ì€ async* í•´ì¤˜ì•¼í•¨ Future ëŠ” ê·¸ëƒ¥ async
  @override
  Stream<TodoState> mapEventToState(TodoEvent event) async* {
    // ë¨¼ì € ì–´ë– í•œ event ì¸ì§€ check í•˜ëŠ” ê²ƒ (ListTodosEvent, CreateTodoEvent, DeleteTodoEvent)
    if (event is ListTodosEvent) {
      yield* _mapListTodoEvent(event);
    } else if (event is CreateTodoEvent) {
      yield* _mapCreateTodoEvent(event);
    } else if (event is DeleteTodoEvent) {
      yield* _mapDeleteTodoEvent(event);
    }
  }

  // ì•„ë˜ì˜ ë¡œì§ì´ ê°€ì¥ ì²˜ìŒìœ¼ë¡œ UI ì™€ ì—°ê²°ë˜ëŠ” ë¶€ë¶„ì´ê¸° ë•Œë¬¸ì— Stream builder í˜•íƒœë¡œ Stream ìœ¼ë¡œ ë“¤ì–´ê°€ê²Œ ë˜ëŠ”ë° UI ì—ì„œ error ê°€ ë‚˜ëŠ”ê²ƒì„ ìµœì†Œí™” ì‹œì¼œ ì¤˜ì•¼ í•¨. ê·¸ë˜ì„œ ëª¨ë“  error ë¥¼ ì´ ë‹¨ê³„ì—ì„œ ì„¤ì •ì„ í•¨(try , catch ë¡œ)
  // _mapListTodoEvent Stream logic ìƒì„±
  Stream<TodoState> _mapListTodoEvent(ListTodosEvent event) async* {
    try {
      // circular indicator ë¥¼ ë³´ì—¬ì£¼ê¸° ìœ„í•´ Loadingì„ í˜¸ì¶œ
      yield Loading();

      // repository ì—ì„œ ê°€ì ¸ì˜¨ ì •ë³´ ë³€ìˆ˜ ì„ ì–¸
      final resp = await this.repository.listTodo();

      // listTodo ëŠ” Map<String, dynamic> ì„ return í•´ì£¼ê¸° ë•Œë¬¸ì— ë”°ë¡œ class í™”ë¥¼ í•´ì¤˜ì•¼ í•¨
      final todos = resp.map<Todo>((e) => Todo.fromJson(e)).toList();

      // ê°’ì„ ê°€ì ¸ì™”ìœ¼ë‹ˆ loading ì´ ëë‚œê²ƒì„ í˜¸ì¶œí•˜ê³  todos ë¥¼ ë„˜ê¸´ë‹¤
      yield Loaded(todos: todos);
    } catch (e) {
      yield Error(message: e.toString());
    }
  }

  // _mapCreateTodoEvent Stream logic ìƒì„±
  Stream<TodoState> _mapCreateTodoEvent(CreateTodoEvent event) async* {
    try {
      // ì•„ë˜ì˜ state ê°€ loaded state ì¸ì§€ í™•ì¸ (ì•„ì§ load ê°€ ì•ˆë¬ëŠ”ë° data ë¥¼ ê°€ì ¸ ì˜¤ë©´ ì•ˆë˜ê¸°ë•Œë¬¸ì—)
      if (state is Loaded) {
        // todo ë¥¼ ë§Œë“¤ê¸° ì „ì— ê¸°ì¡´ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ì•¼ í•¨
        // ëª¨ë‘ yield ëœê²ƒë“¤ì€ state ì•ˆì—ì„œ ê°€ì ¸ì˜¬ìˆ˜ ìˆìŒ state ì¸ë° ì‚¬ì‹¤ ì´ê±´ Loaded state ë¼ëŠ”ê²ƒ
        final parseState = (state as Loaded);

        // todo ìƒì„±
        final newTodo = Todo(
          //  ID: todos ì˜ ê¸¸ì´ -1 ì˜ index ì˜ id ê°’ì´ + 1 í•´ì„œ ì¶”ê°€ ID ë²ˆí˜¸ ìƒì„±
          id: parseState.todos[parseState.todos.length - 1].id + 1,
          // Title : event ì—ì„œ title ì„ ë¶ˆëŸ¬ì˜´
          title: event.title,
          // CreatedAt : ì§€ê¸ˆ ì‹œê°„ í˜¸ì¶œí•´ì„œ String ìœ¼ë¡œ ë°˜í™˜
          createdAt: DateTime.now().toString(),
        );

        // repository ì „ì†¡ì „ì— UI í™”ë©´ì— ë³€ê²½ëœ ë‚´ìš©ì„ í‘œì‹œí•´ì£¼ëŠ”ë¶€ë¶„ todos í˜¸ì¶œ
        // prevTodos ì— ê¸°ì¡´ì— ìˆëŠ”ê²ƒì„ ë³µì‚¬
        final prevTodos = [
          ...parseState.todos,
        ];

        // newTodos ì— ê¸°ì¡´ê±° + ìƒì„±í•œê±° ìƒˆë¡œ ìƒì„±
        final newTodos = [
          ...prevTodos,
          newTodo,
        ];

        // ìš”ì²­ì„ í•˜ê¸°ì „ì— ê°€ìƒìœ¼ë¡œ yield í•˜ê¸° (load ê°€ ë‹¤ ë¬ë‹¤ê³  ì„ì˜ë¡œ ì„ ì–¸ UI ì— í‘œì‹œí•˜ê¸° ìœ„í•´ì„œ)
        yield Loaded(todos: newTodos);

        // repository ë¡œ ë°ì´í„° ì „ì†¡
        final resp = await this.repository.createTodo(newTodo);

        // id ê°’ê³¼ createdAt ì˜ ê°’ì„ ì„œë²„ì— ìˆëŠ” ìª½ê³¼ UI ìª½ì˜ id ì™€ createdAt ì˜ ê°’ì„ ë§ì¶°ì•¼ ë˜ê¸°ë•Œë¬¸ì— repository ì „ì†¡í›„ì— ë‹¤ì‹œ Loaded í˜¸ì¶œí•´ì„œ ì—…ë°ì´íŠ¸ í•˜ëŠ”ê²ƒ
        yield Loaded(todos: [
          ...prevTodos,
          Todo.fromJson(resp),
        ]);
      }
    } catch (e) {
      yield Error(message: e.toString());
    }
  }

  // _mapDeleteTodoEvent Stream logic ìƒì„±
  Stream<TodoState> _mapDeleteTodoEvent(DeleteTodoEvent event) async* {
    try {
      if (state is Loaded) {
        final newTodos = (state as Loaded)
            .todos
            .where((todo) => todo.id != event.todo.id)
            .toList();

        yield Loaded(todos: newTodos);

        await repository.deleteTodo(event.todo);
      }
    } catch (e) {
      yield Error(message: e.toString());
    }
  }
}

```

## cubit ì ìš©í•˜ê¸°

ê¸°ì¡´ UI page ì—ì„œ ë³€ê²½ì‚¬í•­ì€..

- BlocProvider ì˜ `TodoBloc` ëŒ€ì‹  `TodoCubit` ìœ¼ë¡œ ë°”ê¿” ì¤Œ

```dart
  // ListTodosEvent ë¥¼ BlocProvider ì—ì„œ TodoBloc ì„ ë¶€ë¥¼ ìˆ˜ ìˆëŠ”ê²ƒ
  BlocProvider.of<TodoBloc>(context).add(ListTodosEvent());

  // ìœ„ì—ê²ƒì„ TodoCubit ìœ¼ë¡œ ë§Œë“œëŠ”ê²ƒ
  BlocProvider.of<TodoCubit>(context).listTodo();
```

![Kapture 2021-11-03 at 16 20 43](https://user-images.githubusercontent.com/28912774/140021929-b54521cf-3a50-43e1-bb00-199ba2d53954.gif)

## Source Code

> [github source](https://github.com/jacobkosmart/flutter-bloc-practice-todoList)

---

ğŸ”¶ ğŸ”· ğŸ“Œ ğŸ”‘

## Reference

Getting Started with the BLoC Pattern - [https://www.raywenderlich.com/4074597-getting-started-with-the-bloc-pattern](https://www.raywenderlich.com/4074597-getting-started-with-the-bloc-pattern)

BLoC in Flutter: Implement Clean, Flux-like Architecture - [https://everyday.codes/mobile/bloc-in-flutter-implement-clean-flux-like-architecture/](https://everyday.codes/mobile/bloc-in-flutter-implement-clean-flux-like-architecture/)

ê°œë°œí•˜ëŠ”ë‚¨ì - [https://youtu.be/AY6i0a4BM7o](https://youtu.be/AY6i0a4BM7o)

ì½”ë“œíŒ©í† ë¦¬ - [https://youtu.be/xlmkMF5kVvA](https://youtu.be/xlmkMF5kVvA)
